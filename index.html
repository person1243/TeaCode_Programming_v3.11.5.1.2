<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tea Programming Language IDE (Professional Edition - CodeMirror Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    
    <style>
        /* Define custom CSS variables for fonts */
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
        }

        /* Theme Variables */
        /* Each theme defines a set of color variables */
        .theme-matcha {
            --bg-primary: #2A3F35; /* Main background for editor */
            --bg-secondary: #1E2D24; /* Background for sidebars, top bar, terminal */
            --bg-tertiary: #3E554A; /* Hover/active background for elements */
            --text-primary: #E0E0E0; /* Main text color */
            --text-secondary: #A0A0A0; /* Secondary text color (e.g., comments, descriptions) */
            --accent-primary: #6EE7B7; /* Primary accent color (e.g., highlights, active states) */
            --accent-secondary: #34D399; /* Secondary accent color (e.g., buttons, active tabs) */
            --border-color: #4A6357; /* Border color */
            --gradient-start: #2A3F35;
            --gradient-end: #1E2D24;
            --shadow-color: rgba(0,0,0,0.3);
        }

        .theme-earl-grey {
            --bg-primary: #334155;
            --bg-secondary: #1E293B;
            --bg-tertiary: #475569;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --accent-primary: #60A5FA;
            --accent-secondary: #3B82F6;
            --border-color: #475569;
            --gradient-start: #334155;
            --gradient-end: #1E293B;
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        .theme-chai {
            --bg-primary: #4A2E2B;
            --bg-secondary: #3C2421;
            --bg-tertiary: #5C3A36;
            --text-primary: #FDEBD0;
            --text-secondary: #D5BBA2;
            --accent-primary: #F59E0B;
            --accent-secondary: #D97706;
            --border-color: #6B4642;
            --gradient-start: #4A2E2B;
            --gradient-end: #3C2421;
            --shadow-color: rgba(0,0,0,0.3);
        }

        .theme-classic {
            --bg-primary: #282c34;
            --bg-secondary: #21252b;
            --bg-tertiary: #3a4049;
            --text-primary: #abb2bf;
            --text-secondary: #8e9aab;
            --accent-primary: #61afef;
            --accent-secondary: #528bff;
            --border-color: #3a4049;
            --gradient-start: #282c34;
            --gradient-end: #21252b;
            --shadow-color: rgba(0,0,0,0.3);
        }

        /* Base body styles, applying theme variables and smooth transitions */
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Specific component styling using theme variables */
        .top-bar { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        .sidebar { background-color: var(--bg-secondary); transition: width 0.3s ease, transform 0.3s ease; } /* Added transform for responsive slide */
        .editor-bg { background-color: var(--bg-primary); }
        .terminal-bg { background-color: var(--bg-secondary); }
        .panel-header { border-bottom: 1px solid var(--border-color); }
        .file-item.active { background-color: var(--accent-secondary); color: var(--bg-primary); }
        .file-item:hover { background-color: var(--bg-tertiary); }
        .tab { 
            background-color: var(--bg-secondary); 
            color: var(--text-secondary);
            transition: background-color 0.2s ease, color 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        .tab.active { 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-primary); 
        }
        .tab:hover { background-color: var(--bg-tertiary); }
        .btn { 
            background-color: var(--bg-tertiary); 
            color: var(--text-primary); 
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .btn:hover { 
            background-color: var(--accent-secondary); 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .btn-primary { 
            background-color: var(--accent-primary); 
            color: var(--bg-secondary); 
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .btn-primary:hover { 
            background-color: var(--accent-secondary); 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        /* Apply monospace font to code-related elements */
        #terminal-input, #terminal-output, .metadata-input, #command-search, .command-name { font-family: var(--font-mono); }
        #terminal-prompt { color: var(--accent-primary); }
        .command-name { color: var(--accent-primary); }

        /* Custom Scrollbar Styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Terminal specific styles for collapse/fullscreen */
        #terminal {
            height: 33.33%; /* Default 1/3 height */
            transition: height 0.3s ease;
            overflow: hidden; /* Hide scrollbar when collapsed */
        }
        #terminal.collapsed {
            height: 40px; /* Height when collapsed (header only) */
        }
        #terminal.fullscreen {
            height: 100%; /* Full height of its parent */
            flex-grow: 1; /* Take all available space */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            border-top: none;
            border-radius: 0;
        }
        #terminal.fullscreen #terminal-output {
            height: calc(100% - 70px);
        }
        #terminal-output {
            overflow-y: auto;
        }

        /* Responsive adjustments for sidebars */
        @media (max-width: 1024px) {
            .sidebar {
                position: absolute;
                top: 0;
                bottom: 0;
                z-index: 10;
                width: 280px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            #left-sidebar {
                left: 0;
                transform: translateX(-100%);
            }
            #left-sidebar.open {
                transform: translateX(0);
            }
            #right-sidebar {
                right: 0;
                transform: translateX(100%);
            }
            #right-sidebar.open {
                transform: translateX(0);
            }
            .main-content-area {
                width: 100%;
            }
        }

        /* Custom Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--bg-primary);
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            border: 1px solid var(--border-color);
        }
        .close-button {
            color: var(--text-secondary);
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--accent-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .modal-input {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .modal-error {
            color: #ef4444;
            margin-top: -10px;
            margin-bottom: 10px;
            font-size: 0.875rem;
        }

        /* CodeMirror specific styling adjustments */
        .CodeMirror {
            height: 100%; /* Make CodeMirror fill its container */
            font-family: var(--font-mono);
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            background-color: var(--bg-primary); /* Match editor-bg */
            color: var(--text-primary); /* Match text-primary */
            border-radius: 0 0 8px 8px; /* Rounded bottom corners */
        }
        .CodeMirror-gutters {
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
        }
        .CodeMirror-linenumber {
            color: var(--text-secondary);
        }
        .CodeMirror-cursor {
            border-left: 1px solid var(--accent-primary);
        }
        .CodeMirror-activeline-background {
            background: var(--bg-tertiary);
        }
        .CodeMirror-selected {
            background: var(--accent-primary) !important;
            color: var(--bg-primary) !important;
        }
        /* Styling for the output sandbox */
        #output-sandbox {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 100px; /* Ensure it's visible */
            overflow: auto;
            color: var(--text-primary);
            font-family: var(--font-sans);
            display: flex; /* Allow flex layout for created UI elements */
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-start;
            justify-content: flex-start;
        }
        #output-sandbox button {
            background-color: var(--accent-secondary);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }
        #output-sandbox button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="theme-matcha">

    <!-- Main App Container (Always visible, no auth screen) -->
    <div id="app-container" class="min-h-screen flex flex-col">
        <!-- Top Bar -->
        <div class="top-bar p-2 flex items-center justify-between flex-shrink-0 rounded-b-lg shadow-md">
            <div class="flex items-center space-x-4">
                <!-- New Tea IDE Logo/Icon (Stylized 'T' for Tea) -->
                <svg class="w-8 h-8" style="color: var(--accent-primary)" fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                    <path d='M14 3.5a.5.5 0 0 0-.5-.5h-12a.5.5 0 0 0-.5.5v.643l.706.706A4.5 4.5 0 0 0 4.5 9.5h7A4.5 4.5 0 0 0 13.794 4.85L14 4.643V3.5zm-1 0v.228l-.354.353a3.5 3.5 0 0 1-4.43 4.43L6 8.5h4a3.5 3.5 0 0 1 3.5-3.5zM.5 10a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1H.5zm.5 2.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1H1z'/>
                </svg>
                <span class="text-xl font-bold">Tea IDE (Professional Edition)</span>
                <div class="flex space-x-2">
                    <!-- Basic menu buttons (functionality not implemented in this demo) -->
                    <button class="btn px-3 py-1 rounded-md shadow-sm">File</button>
                    <button class="btn px-3 py-1 rounded-md shadow-sm">Edit</button>
                    <!-- Run Tea Code Button -->
                    <button id="run-code-btn" class="btn-primary font-semibold px-3 py-1 rounded-md shadow-sm">▶ Run Code</button>
                    <!-- Theme Switcher Dropdown -->
                    <select id="theme-switcher" class="btn px-3 py-1 rounded-md shadow-sm cursor-pointer">
                        <option value="theme-matcha">Matcha</option>
                        <option value="theme-earl-grey">Earl Grey</option>
                        <option value="theme-chai">Chai</option>
                        <option value="theme-classic">Classic Dark</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <!-- User Status -->
                <span id="user-status" class="text-sm text-secondary">Active Database: guest_dev</span>
                <button id="view-databases-btn" class="btn px-3 py-1 rounded-md shadow-sm">Databases</button>
                <button id="reset-ide-btn" class="btn px-3 py-1 rounded-md shadow-sm">Reset IDE</button>
                <!-- Export Project Button -->
                <button id="export-btn" class="btn-primary font-semibold px-4 py-2 rounded-md shadow-lg transform hover:scale-105 transition-transform duration-200">Export All Files</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-grow overflow-hidden relative lg:static">
            <!-- Left Sidebar -->
            <div id="left-sidebar" class="sidebar w-64 p-4 flex flex-col flex-shrink-0 rounded-r-lg lg:static lg:translate-x-0">
                <h2 class="text-xl font-bold mb-4 panel-header pb-2">File Explorer</h2>
                <div id="file-explorer" class="flex-grow overflow-y-auto custom-scrollbar pr-2"></div>
                <div class="flex space-x-2 mt-4">
                    <button id="new-file-btn" class="btn-primary font-semibold px-3 py-1 rounded-md w-full shadow-sm">New .tpr</button>
                    <input type="file" id="file-upload" class="hidden" accept=".tpr,.tea-project">
                    <button id="open-file-btn" class="btn px-3 py-1 rounded-md w-full shadow-sm">Open .tpr</button>
                </div>

                <!-- Removed Projects Section -->
            </div>

            <!-- Main Editor and Terminal -->
            <div class="flex-grow flex flex-col main-content-area">
                <div class="flex items-center bg-secondary">
                    <!-- Toggle Left Sidebar Button -->
                    <button id="toggle-left" class="p-2 btn m-1 rounded-md shadow-sm lg:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                    </button>
                    <!-- Tabs Container -->
                    <div id="tabs-container" class="flex flex-grow border-b overflow-x-auto" style="border-color: var(--border-color);">
                        <!-- "Command Dictionary" tab will be dynamically added here -->
                    </div>
                    <!-- Toggle Right Sidebar Button -->
                     <button id="toggle-right" class="p-2 btn m-1 rounded-md shadow-sm lg:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M13 18h7"></path></svg>
                    </button>
                </div>
                <!-- Code Editor Area (CodeMirror will attach here) -->
                <div id="editor-container" class="flex-grow editor-bg p-1 rounded-b-lg">
                    <!-- CodeMirror will be initialized here -->
                </div>
                <!-- Command Dictionary Panel (now within main content, toggled by tab) -->
                <div id="command-dictionary-panel" class="flex-grow editor-bg p-4 flex flex-col rounded-b-lg hidden">
                    <h3 class="text-lg font-bold mb-3 panel-header pb-2">Command Dictionary</h3>
                    <input type="text" id="command-search" class="bg-tertiary w-full mb-3 p-2 rounded-md text-sm" placeholder="Search commands...">
                    <div id="command-list" class="editor-bg p-3 rounded-md flex-grow overflow-y-auto text-sm custom-scrollbar space-y-2"></div>
                </div>
                <!-- Output Sandbox for UI elements -->
                <div id="output-sandbox" class="flex-grow editor-bg p-4 rounded-b-lg hidden">
                    <p class="text-secondary">Run code to see UI elements appear here!</p>
                </div>
                <!-- Terminal Area -->
                <div id="terminal" class="h-1/3 terminal-bg p-4 flex flex-col border-t rounded-t-lg" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between mb-2 panel-header pb-2 cursor-pointer" id="terminal-header-toggle">
                        <h3 class="text-lg font-bold">Terminal</h3>
                        <div class="flex space-x-2">
                            <button id="terminal-fullscreen-btn" class="btn px-2 py-1 rounded-md text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m-4 7v4m0 0h-4m0 0l5-5m11 1v4m0 0h-4m0 0l-5-5"></path></svg>
                            </button>
                            <button id="terminal-collapse-btn" class="btn px-2 py-1 rounded-md text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="terminal-content" class="flex-grow flex flex-col">
                        <div id="terminal-output" class="flex-grow bg-black/20 p-2 rounded-md overflow-y-auto text-sm custom-scrollbar"></div>
                        <div class="flex mt-2 items-center">
                            <span id="terminal-prompt" class="mr-2">$</span>
                            <input type="text" id="terminal-input" class="bg-transparent border-none w-full focus:outline-none text-sm" placeholder="Type commands here (e.g., 'clear', 'help')">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar (AI Assistant Only) -->
            <div id="right-sidebar" class="sidebar w-80 p-4 flex flex-col flex-shrink-0 rounded-l-lg lg:static lg:translate-x-0">
                <!-- AI Assistant Panel -->
                <div class="flex-1 flex flex-col min-h-0">
                    <h3 class="text-lg font-bold mb-3 panel-header pb-2">AI Assistant</h3>
                    <div id="ai-output" class="editor-bg p-3 rounded-md flex-grow overflow-y-auto text-sm custom-scrollbar mb-4">
                        <p class="text-secondary">I'm your AI assistant, TeaCognito! How may I assist your development today?</p>
                    </div>
                    <div class="flex flex-col space-y-3 mt-2">
                        <button id="explain-code-btn" class="btn w-full rounded-md shadow-sm py-2">✨ Explain Code</button>
                        <button id="refactor-code-btn" class="btn w-full rounded-md shadow-sm py-2">✨ Refactor Code</button>
                        <button id="train-ai-btn" class="btn w-full rounded-md shadow-sm py-2">✨ Train AI (Simulated)</button>
                        <input type="text" id="ai-input" class="bg-tertiary w-full p-2 rounded-md text-sm mt-3" placeholder="Ask for help or 'Generate code for...' ">
                        <button id="generate-code-btn" class="btn-primary w-full rounded-md shadow-sm py-2">✨ Generate Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Prompts/Alerts -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="mb-4"></p>
            <input type="text" id="modal-input" class="modal-input hidden" placeholder="Enter value...">
            <p id="modal-error-message" class="modal-error hidden"></p>
            <div id="modal-buttons" class="flex justify-end space-x-2">
                <button id="modal-cancel-btn" class="btn px-4 py-2 rounded-md hidden">Cancel</button>
                <button id="modal-ok-btn" class="btn-primary px-4 py-2 rounded-md">OK</button>
            </div>
        </div>
    </div>

    <!-- Removed Coffee Spill Overlay and Message -->

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>

    <script type="module">
        // --- Simulated Database Key (User ID) ---
        // This key determines which section of the local database is currently active.
        let currentUserId = localStorage.getItem('active_simulated_db_key') || 'guest_dev';
        document.getElementById('user-status').textContent = `Active Database: ${currentUserId}`;

        // --- DOM ELEMENTS ---
        // Cache DOM elements for efficient access
        const dom = {
            body: document.body,
            leftSidebar: document.getElementById('left-sidebar'),
            rightSidebar: document.getElementById('right-sidebar'),
            toggleLeft: document.getElementById('toggle-left'),
            toggleRight: document.getElementById('toggle-right'),
            fileExplorer: document.getElementById('file-explorer'),
            editorContainer: document.getElementById('editor-container'), // The div where CodeMirror attaches
            commandDictionaryPanel: document.getElementById('command-dictionary-panel'),
            outputSandbox: document.getElementById('output-sandbox'), // New: for UI output
            terminal: document.getElementById('terminal'),
            terminalHeaderToggle: document.getElementById('terminal-header-toggle'),
            terminalContent: document.getElementById('terminal-content'),
            terminalOutput: document.getElementById('terminal-output'),
            terminalInput: document.getElementById('terminal-input'),
            terminalFullscreenBtn: document.getElementById('terminal-fullscreen-btn'),
            terminalCollapseBtn: document.getElementById('terminal-collapse-btn'),
            commandList: document.getElementById('command-list'),
            commandSearch: document.getElementById('command-search'),
            newFileBtn: document.getElementById('new-file-btn'),
            openFileBtn: document.getElementById('open-file-btn'),
            fileUpload: document.getElementById('file-upload'),
            tabsContainer: document.getElementById('tabs-container'),
            themeSwitcher: document.getElementById('theme-switcher'),
            aiOutput: document.getElementById('ai-output'),
            aiInput: document.getElementById('ai-input'),
            exportBtn: document.getElementById('export-btn'),
            runCodeBtn: document.getElementById('run-code-btn'),
            explainCodeBtn: document.getElementById('explain-code-btn'),
            refactorCodeBtn: document.getElementById('refactor-code-btn'),
            generateCodeBtn: document.getElementById('generate-code-btn'),
            trainAiBtn: document.getElementById('train-ai-btn'),
            viewDatabasesBtn: document.getElementById('view-databases-btn'),
            resetIdeBtn: document.getElementById('reset-ide-btn')
        };

        // --- Debugging: Verify DOM elements are found ---
        console.log('--- DOM Element Initialization Check ---');
        for (const key in dom) {
            if (dom[key] === null) {
                console.error(`ERROR: DOM element '${key}' not found! Please check your HTML IDs.`);
            } else {
                console.log(`SUCCESS: DOM element '${key}' found.`);
            }
        }
        console.log('--------------------------------------');

        // --- CodeMirror Editor Instance ---
        let editor; // This will hold the CodeMirror instance

        // --- Custom Modal Implementation (replacing prompt/alert) ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const closeButton = customModal.querySelector('.close-button');
        const modalErrorMessage = document.getElementById('modal-error-message');

        let modalResolve;
        let modalReject;

        function showModal(title, message, inputConfig = { type: 'none', placeholder: '' }) {
            return new Promise((resolve, reject) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalInput.value = ''; // Clear previous input
                clearModalError();

                if (inputConfig.type !== 'none') {
                    modalInput.classList.remove('hidden');
                    modalInput.type = inputConfig.type;
                    modalInput.placeholder = inputConfig.placeholder;
                    modalInput.focus();
                    modalCancelBtn.classList.remove('hidden');
                } else {
                    modalInput.classList.add('hidden');
                    modalCancelBtn.classList.add('hidden');
                }

                customModal.style.display = 'flex'; // Show modal

                modalResolve = resolve;
                modalReject = reject;
            });
        }

        function closeModal() {
            customModal.style.display = 'none';
            modalInput.classList.add('hidden'); // Ensure input is hidden on close
            clearModalError();
        }

        function displayModalError(message) {
            modalErrorMessage.textContent = message;
            modalErrorMessage.classList.remove('hidden');
        }

        function clearModalError() {
            modalErrorMessage.classList.add('hidden');
            modalErrorMessage.textContent = '';
        }

        modalOkBtn.onclick = () => {
            if (!modalInput.classList.contains('hidden') && modalInput.value.trim() === '') {
                displayModalError('Input cannot be empty.');
                return;
            }
            closeModal();
            if (modalInput.classList.contains('hidden')) {
                modalResolve(true); // For alert-like behavior
            } else {
                modalResolve(modalInput.value); // For prompt-like behavior
            }
        };

        modalCancelBtn.onclick = () => {
            closeModal();
            modalReject(new Error('Modal cancelled.')); // For prompt-like behavior
        };

        closeButton.onclick = () => {
            closeModal();
            modalReject(new Error('Modal closed by outside click.')); // Treat closing as cancellation
        };

        window.onclick = (event) => {
            if (event.target === customModal) {
                closeModal();
                modalReject(new Error('Modal closed by outside click.'));
            }
        };
        // End Custom Modal

        // --- Simulated Local Database Functions ---

        /**
         * Retrieves the entire simulated database from localStorage.
         * @returns {object} The parsed database object.
         */
        function getSimulatedDatabase() {
            try {
                return JSON.parse(localStorage.getItem('simulated_tea_db') || '{}');
            } catch (e) {
                console.error("Error parsing simulated_tea_db from localStorage:", e);
                return {};
            }
        }

        /**
         * Saves the entire simulated database object to localStorage.
         * @param {object} db - The database object to save.
         */
        function setSimulatedDatabase(db) {
            localStorage.setItem('simulated_tea_db', JSON.stringify(db));
        }

        /**
         * Saves a file's content to the simulated local database under the current user's key.
         * @param {string} fileName - The name of the file to save.
         * @param {string} content - The content of the file.
         */
        async function simulatedSaveFile(fileName, content) {
            const db = getSimulatedDatabase();
            db[currentUserId] = db[currentUserId] || {}; // Ensure user's section exists
            db[currentUserId][fileName] = content;
            setSimulatedDatabase(db);
            logToTerminal(`Local DB: Saved '${fileName}' for '${currentUserId}' successfully.`, 'info');
        }

        /**
         * Loads a file's content from the simulated local database for the current user.
         * @param {string} fileName - The name of the file to load.
         * @returns {string | null} The loaded content, or null if not found.
         */
        function simulatedLoadFile(fileName) {
            const db = getSimulatedDatabase();
            const userData = db[currentUserId] || {};
            if (userData.hasOwnProperty(fileName)) {
                logToTerminal(`Local DB: Loaded '${fileName}' for '${currentUserId}'.`, 'info');
                return userData[fileName];
            }
            logToTerminal(`Local DB: File '${fileName}' not found for '${currentUserId}'.`, 'info');
            return null;
        }

        /**
         * Deletes a file from the simulated local database for the current user.
         * @param {string} fileName - The name of the file to delete.
         */
        function simulatedDeleteFile(fileName) {
            const db = getSimulatedDatabase();
            if (db[currentUserId] && db[currentUserId].hasOwnProperty(fileName)) {
                delete db[currentUserId][fileName];
                setSimulatedDatabase(db);
                logToTerminal(`Local DB: Deleted '${fileName}' for '${currentUserId}'.`, 'info');
            } else {
                logToTerminal(`Local DB: File '${fileName}' not found for '${currentUserId}' to delete.`, 'info');
            }
        }

        /**
         * Lists all file names stored for the current user in the simulated local database.
         * @returns {string[]} An array of file names.
         */
        function simulatedListFiles() {
            const db = getSimulatedDatabase();
            const userData = db[currentUserId] || {};
            const files = Object.keys(userData);
            logToTerminal(`Local DB: Files for '${currentUserId}': ${files.join(', ') || 'None'}.`, 'info');
            return files;
        }

        /**
         * Sets the active database key (user ID) and reloads the IDE state to reflect files
         * associated with the new key.
         * @param {string} newKey - The new database key (user ID) to activate.
         */
        async function setActiveDatabaseKey(newKey) {
            const keyAsString = String(newKey || '').trim(); 

            if (keyAsString === '') {
                logToTerminal("Error: Invalid database key. Key cannot be empty.", "error");
                return;
            }
            currentUserId = keyAsString;
            localStorage.setItem('active_simulated_db_key', currentUserId);
            document.getElementById('user-status').textContent = `Active Database: ${currentUserId}`;
            logToTerminal(`Switched active database to: '${currentUserId}'.`, 'info');
            
            state.files = {};
            state.openTabs = [];
            state.activeFile = null;
            const userFiles = getSimulatedDatabase()[currentUserId] || {};
            state.files = { ...userFiles };
            const fileNames = Object.keys(state.files);
            if (fileNames.length > 0) {
                const previouslyActiveFile = localStorage.getItem(`active_file_${currentUserId}`);
                if (previouslyActiveFile && state.files.hasOwnProperty(previouslyActiveFile)) {
                    openFile(previouslyActiveFile);
                } else {
                    openFile(fileNames[0]);
                }
            } else {
                createNewFile();
            }
            renderFileExplorer();
            renderTabs();
        }

        /**
         * Displays all available database keys (user IDs) and allows the user to switch
         * to an existing one or create a new one.
         */
        async function viewAllDatabases() {
            const db = getSimulatedDatabase();
            const allKeys = Object.keys(db);
            let message = `Available Database Keys: ${allKeys.join(', ') || 'None'}.`;
            if (allKeys.length > 0) {
                message += `\n\nEnter a key to switch to it, or enter a new key to create/switch to it.`;
            } else {
                message += `\n\nEnter a new key to create your first database section.`;
            }

            try {
                const newKey = await showModal('View/Switch Databases', message, { type: 'text', placeholder: 'Enter database key' });
                if (newKey) {
                    setActiveDatabaseKey(newKey);
                }
            } catch (error) {
                logToTerminal(`Database view/switch cancelled: ${error.message}.`, 'info');
            }
        }

        // --- DATA & STATE MANAGEMENT ---
        // Defines the available commands for the Tea programming language
        const teaCommands = [
            // UI Commands (C++-like syntax)
            { name: 'UI.CreateElement(string type, string id);', desc: 'Creates a new UI element of specified type and ID.' },
            { name: 'UI.DestroyElement(string id);', desc: 'Removes a UI element from the DOM.' },
            { name: 'UI.SetAttribute(string id, string attribute, string value);', desc: 'Sets an attribute for a UI element.' },
            { name: 'UI.GetAttribute(string id, string attribute);', desc: 'Retrieves an attribute value from a UI element.' },
            { name: 'UI.SetText(string id, string text);', desc: 'Sets the inner text content of a UI element.' },
            { name: 'UI.SetStyle(string id, string property, string value);', desc: 'Applies a CSS style to a UI element.' },
            { name: 'UI.AttachEvent(string id, string eventType, string callbackCode);', desc: 'Attaches an event listener to a UI element.' },
            { name: 'UI.AddClass(string id, string className);', desc: 'Adds a CSS class to a UI element.' },
            { name: 'UI.RemoveClass(string id, string className);', desc: 'Removes a CSS class from a UI element.' },
            { name: 'UI.ToggleVisibility(string id);', desc: 'Toggles the visibility of a UI element.' },
            { name: 'UI.AnimateElement(string id, string property, string value, int duration);', desc: 'Animates a CSS property of a UI element.' },
            { name: 'UI.Canvas.Create(string id, int width, int height);', desc: 'Creates a new canvas element.' },
            { name: 'UI.Canvas.DrawRectangle(string id, int x, int y, int width, int height, string color);', desc: 'Draws a rectangle on a canvas.' },
            { name: 'UI.Canvas.DrawLine(string id, int x1, int y1, int x2, int y2, string color);', desc: 'Draws a line on a canvas.' },
            { name: 'UI.Canvas.DrawCircle(string id, int x, int y, int radius, string color);', desc: 'Draws a circle on a canvas.' },
            { name: 'UI.Canvas.DrawImage(string id, string source, int x, int y, int width, int height);', desc: 'Draws an image on a canvas.' },
            { name: 'UI.Canvas.Clear(string id);', desc: 'Clears a canvas.' },
            { name: 'UI.DisplayStaticText(string id, string content);', desc: 'Displays static text content in the output sandbox.' },

            // Local Database Commands (C++-like syntax)
            { name: 'Data.StoreValue(string key, string value);', desc: 'Stores a key-value pair in the active local database section. Supports variable names for key/value.' },
            { name: 'Data.RetrieveValue(string key);', desc: 'Retrieves a value from the active local database section. Returns the value.' },
            { name: 'Data.DeleteValue(string key);', desc: 'Deletes a key-value pair from the active local database section.' },
            { name: 'Data.ListKeys();', desc: 'Lists all keys in the active local database section.' },
            { name: 'Data.ParseJSON(string jsonString);', desc: 'Parses a JSON string into a Tea object.' },
            { name: 'Data.StringifyJSON(object obj);', desc: 'Converts a Tea object into a JSON string.' },
            { name: 'Data.Array.Push(array arr, any item);', desc: 'Adds an item to an array.' },
            { name: 'Data.Array.Pop(array arr);', desc: 'Removes the last item from an array.' },
            { name: 'Data.Array.GetLength(array arr);', desc: 'Returns the length of an array.' },
            { name: 'Data.List.Map(list lst, string functionName);', desc: 'Applies a function to each item in a list, returning a new list.' },
            { name: 'Data.List.Filter(list lst, string functionName);', desc: 'Filters a list based on a function, returning a new list.' },
            { name: 'Data.Dictionary.Create();', desc: 'Creates a new empty dictionary (object).' },
            { name: 'Data.Dictionary.GetValue(dictionary dict, string key);', desc: 'Retrieves a value from a dictionary by its key.' },
            { name: 'Data.Dictionary.SetValue(dictionary dict, string key, any value);', desc: 'Sets a value in a dictionary by its key.' },
            { name: 'Data.Set.Create();', desc: 'Creates a new empty set.' },
            { name: 'Data.Set.Add(set s, any item);', desc: 'Adds an item to a set.' },
            { name: 'Data.Set.Has(set s, any item);', desc: 'Checks if a set contains an item.' },
            
            // Debugging (C++-like syntax)
            { name: 'Debug.Log(string message);', desc: 'Prints a message to the debug console. Supports variable names.' },

            // System Commands (C++-like syntax)
            { name: 'System.GetCurrentTime();', desc: 'Retrieves the current system time.' },
            { name: 'System.GenerateRandom(int min, int max);', desc: 'Generates a random number within a specified range.' },

            // Arithmetic Commands (C++-like syntax)
            { name: 'Math.Add(double num1, double num2);', desc: 'Calculates the sum of two numbers.' },
            { name: 'Math.Subtract(double num1, double num2);', desc: 'Calculates the difference between two numbers.' },
            { name: 'Math.Multiply(double num1, double num2);', desc: 'Computes the product of two numbers.' },
            { name: 'Math.Divide(double num1, double num2);', desc: 'Determines the quotient of two numbers.' },
            { name: 'Math.Power(double base, double exponent);', desc: 'Raises a base to the power of an exponent.' },
            { name: 'Math.SquareRoot(double number);', desc: 'Calculates the square root of a number.' },
            { name: 'Math.SolveLinear(double m, double b, double y_value);', desc: 'Solves a linear equation $y = mx + b$ for $x$.' },
            { name: 'Math.SolveQuadratic(double a, double b, double c);', desc: 'Solves a quadratic equation $ax^2 + bx + c = 0$ for $x$.' },

            // LLM Commands (C++-like syntax)
            { name: 'AI.ExplainCode(string code);', desc: 'Uses AI to explain Tea code.' },
            { name: 'AI.RefactorCode(string code);', desc: 'Uses AI to refactor Tea code.' },
            { name: 'AI.GenerateCode(string prompt);', desc: 'Uses AI to generate Tea code from a description.' },
            { name: 'AI.TrainModel(string type, string input, string output);', desc: 'Simulates AI training.' },
        ];

        // Centralized state object for the IDE
        const state = {
            files: {}, // Stores all files loaded into the IDE (fileName -> content) for the *active* database key
            openTabs: [], // Array of fileNames currently open in tabs
            activeFile: null, // Name of the currently active file (must be in openTabs, or 'commands-tab')
            terminalState: 'default', // 'default', 'collapsed', 'fullscreen'
        };

        // --- FUNCTIONS ---

        /**
         * Saves the current content of the code editor to the active file in state.
         * This function now saves to the simulated local database.
         */
        function saveCurrentFile() {
            if (state.activeFile && state.activeFile !== 'commands-tab' && state.files.hasOwnProperty(state.activeFile)) {
                state.files[state.activeFile] = editor.getValue(); // Use CodeMirror's getValue()
                simulatedSaveFile(state.activeFile, editor.getValue());
            }
        }

        /**
         * Renders (or re-renders) the file explorer list in the left sidebar.
         */
        function renderFileExplorer() {
            dom.fileExplorer.innerHTML = ''; // Clear existing list
            // Sort files alphabetically for better organization
            const sortedFileNames = Object.keys(state.files).sort();
            if (sortedFileNames.length === 0) {
                dom.fileExplorer.innerHTML = `<p class="text-secondary text-sm">No files in current database section.</p>`;
            }
            sortedFileNames.forEach(fileName => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item p-2 cursor-pointer rounded-md ${fileName === state.activeFile ? 'active' : ''}`;
                fileItem.textContent = fileName;
                // Attach click listener to open the file
                fileItem.addEventListener('click', () => openFile(fileName));
                dom.fileExplorer.appendChild(fileItem);
            });
        }

        /**
         * Renders (or re-renders) the tabs for open files and the Command Dictionary tab.
         */
        function renderTabs() {
            dom.tabsContainer.innerHTML = ''; // Clear existing tabs

            // Add the static Command Dictionary tab first
            const commandTab = document.createElement('div');
            commandTab.className = `tab px-4 py-2 cursor-pointer text-sm rounded-t-md flex items-center space-x-2 ${state.activeFile === 'commands-tab' ? 'active' : ''}`;
            commandTab.innerHTML = `<span>Command Dictionary</span>`;
            commandTab.addEventListener('click', () => openCommandsTab());
            dom.tabsContainer.appendChild(commandTab);

            // Add dynamic file tabs
            state.openTabs.filter(fileName => fileName !== 'commands-tab').forEach(fileName => {
                const tab = document.createElement('div');
                tab.className = `tab px-4 py-2 cursor-pointer text-sm rounded-t-md flex items-center space-x-2 ${fileName === state.activeFile ? 'active' : ''}`;
                tab.innerHTML = `<span>${fileName}</span>
                                 <button class="close-tab-btn text-xs ml-2 px-1 py-0.5 rounded-full hover:bg-red-500 hover:text-white transition-colors duration-150" data-file="${fileName}">x</button>`;
                // Attach click listener to switch to the file
                tab.addEventListener('click', (event) => {
                    if (!event.target.classList.contains('close-tab-btn')) {
                        openFile(fileName);
                    }
                });
                // Attach click listener for the close button
                tab.querySelector('.close-tab-btn').addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent tab from activating when closing
                    closeTab(fileName);
                });
                dom.tabsContainer.appendChild(tab);
            });
            // Ensure the active tab is visible if there are many tabs
            const activeTabElement = dom.tabsContainer.querySelector('.tab.active');
            if (activeTabElement) {
                activeTabElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            updateMainContentVisibility();
        }

        /**
         * Toggles visibility of editor vs. command dictionary panel vs. output sandbox based on active tab.
         */
        function updateMainContentVisibility() {
            if (state.activeFile === 'commands-tab') {
                editor.getWrapperElement().classList.add('hidden'); // Hide CodeMirror
                dom.outputSandbox.classList.add('hidden'); // Hide output sandbox
                dom.commandDictionaryPanel.classList.remove('hidden'); // Show command dictionary
                populateCommandDictionary(dom.commandSearch.value); // Re-populate when shown
            } else {
                dom.commandDictionaryPanel.classList.add('hidden'); // Hide command dictionary
                // Determine whether to show editor or output sandbox
                if (state.activeFile === 'output-tab') { // Assuming a new 'output-tab' for sandbox
                    editor.getWrapperElement().classList.add('hidden');
                    dom.outputSandbox.classList.remove('hidden');
                } else {
                    editor.getWrapperElement().classList.remove('hidden'); // Show CodeMirror
                    dom.outputSandbox.classList.add('hidden');
                }
            }
        }

        /**
         * Opens the Command Dictionary tab.
         */
        function openCommandsTab() {
            console.log('Command Dictionary tab clicked.');
            saveCurrentFile(); // Save current file before switching

            state.activeFile = 'commands-tab';
            renderTabs();
            renderFileExplorer(); // Update highlighting in file explorer (no file active)
            dom.commandSearch.focus(); // Focus search when commands tab is active
            logToTerminal('Command Dictionary opened.', 'info');
        }

        /**
         * Opens a specified file, loads its content into the editor, and updates UI.
         * If the file is not already in open tabs, it's added.
         * @param {string} fileName - The name of the file to open.
         */
        function openFile(fileName) {
            console.log(`Opening file: ${fileName}`);
            saveCurrentFile(); // Save changes to the previously active file

            // If file is not already open, add it to openTabs
            if (!state.openTabs.includes(fileName)) {
                state.openTabs.push(fileName);
            }
            
            state.activeFile = fileName; // Set the new active file
            editor.setValue(state.files[fileName] || ''); // Load content into CodeMirror
            editor.focus(); // Focus the editor
            renderFileExplorer(); // Update file explorer highlighting
            renderTabs(); // Update tabs highlighting
            localStorage.setItem(`active_file_${currentUserId}`, fileName); // Save active file per user
            logToTerminal(`File '${fileName}' is now active.`, 'info');
        }

        /**
         * Closes a specified file tab. If it was the active tab, switches to another or creates a new file.
         * @param {string} fileNameToClose - The name of the file to close.
         */
        function closeTab(fileNameToClose) {
            console.log(`Closing tab for file: ${fileNameToClose}`);
            saveCurrentFile(); // Save content before closing if it was the active file

            // Remove the file from openTabs
            state.openTabs = state.openTabs.filter(name => name !== fileNameToClose);
            
            // If the closed file was the active one, determine the new active file
            if (state.activeFile === fileNameToClose) {
                if (state.openTabs.length > 0) {
                    openFile(state.openTabs[0]); // Switch to the first open tab
                } else {
                    state.activeFile = null; // No active file
                    editor.setValue(''); // Clear editor
                    createNewFile(); // Always create a new file if all tabs are closed
                }
            }
            renderFileExplorer();
            renderTabs();
            logToTerminal(`Closed file: ${fileNameToClose}.`, 'info');
        }

        /**
         * Creates a new untitled Tea file and opens it in a new tab.
         * This now applies to the currently active database key.
         */
        async function createNewFile() {
            console.log('Attempting to create new file.');
            let newFileName = `untitled-${Object.keys(state.files).length + 1}.tpr`;
            while (state.files.hasOwnProperty(newFileName)) {
                newFileName = `untitled-${Object.keys(state.files).length + Math.floor(Math.random() * 1000)}.tpr`;
            }
            state.files[newFileName] = `// Welcome to your new Tea file for database key: ${currentUserId}
// Example: Debug.Log("Hello from Tea!");
// Example: UI.CreateElement("button", "myButton");
// UI.SetText("myButton", "Click Me!");
// UI.AttachEvent("myButton", "click", "Debug.Log(\\"Button clicked!\\");");
// Example: UI.DisplayStaticText("myTextDiv", "This is some static text.");
// Example: Debug.Log(Math.Add(5.0, 3.0));
// Example: Debug.Log(Math.SolveQuadratic(1.0, -3.0, 2.0));
// Example: Data.StoreValue("myStoredValue", "This is a test.");
// Example: Debug.Log(Data.RetrieveValue("myStoredValue"));`;
            openFile(newFileName);
            simulatedSaveFile(newFileName, state.files[newFileName]); // Save to local DB immediately
            logToTerminal(`Created new file '${newFileName}' for active database key '${currentUserId}'.`, 'success');
        }
        
        /**
         * Logs a message to the terminal output.
         * @param {string} message - The message to log.
         * @param {string} type - Type of message ('info', 'input', 'error', 'success').
         */
        function logToTerminal(message, type = 'info') {
            if (!dom || !dom.terminalOutput) {
                console.error("Critical Error: dom.terminalOutput is not defined when trying to log:", message);
                return;
            }

            const p = document.createElement('p');
            if (type === 'input') {
                p.innerHTML = `<span id="terminal-prompt" class="mr-2">$</span> ${message}`;
            } else if (type === 'error') {
                p.className = 'text-red-400 font-bold';
                p.textContent = `ERROR: ${message}`;
            } else if (type === 'success') {
                p.className = 'text-green-400';
                p.textContent = `SUCCESS: ${message}`;
            }
            else {
                p.className = 'text-gray-400';
                p.textContent = message;
            }
            dom.terminalOutput.appendChild(p);
            dom.terminalOutput.scrollTop = dom.terminalOutput.scrollHeight; // Scroll to bottom
        }

        // Removed showCoffeeSpillAnimation function

        /**
         * Handles commands entered into the terminal.
         * Now only handles 'clear', 'help'.
         * @param {string} command - The command string entered by the user.
         */
        async function handleTerminalCommand(command) {
            console.log('Terminal command received:', command);
            logToTerminal(command, 'input');
            if (!command) return;

            const cmd = command.trim().toLowerCase();

            if (cmd === 'clear') {
                dom.terminalOutput.innerHTML = '';
                logToTerminal('Terminal output cleared.', 'info');
            } else if(cmd === 'help') {
                logToTerminal("Available terminal commands: clear, help. For Tea language commands, refer to the Command Dictionary tab.", 'info');
            } else {
                logToTerminal(`Command '${command}' not recognized.`, 'error');
            }
        }
        
        /**
         * Logs a message to the AI assistant output.
         * @param {string} message - The message to log.
         * @param {string} from - Who the message is from ('user' or 'ai').
         */
        function logToAI(message, from = 'ai') {
            if (!dom || !dom.aiOutput) {
                console.error("Critical Error: dom.aiOutput is not defined when trying to log to AI:", message);
                return;
            }

            const p = document.createElement('p');
            p.className = `text-sm mb-2 ${from === 'user' ? 'text-right' : ''}`;
            p.innerHTML = from === 'user' 
                ? `<span class="bg-accent-secondary/50 rounded-md px-3 py-1 inline-block">${message}</span>`
                : `<span class="font-bold" style="color: var(--accent-primary);">AI Assistant:</span> ${message}`;
            dom.aiOutput.appendChild(p);
            dom.aiOutput.scrollTop = dom.aiOutput.scrollHeight; // Scroll to bottom
        }
        
        /**
         * Handles general chat queries sent to the Gemini API.
         * @param {string} message - The message string from the user.
         */
        async function handleAIQuery(message) {
            console.log('AI chat query received:', message);
            logToAI(message, 'user');
            if (!message) {
                logToAI("Please provide a query for the AI assistant.", 'info');
                return;
            }

            logToAI("AI Assistant: Processing your request...", 'info');

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: message }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('Gemini chat response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    logToAI(text, 'ai');
                } else {
                    logToAI(`Error: Failed to retrieve response from AI. Unexpected response structure.`, 'error');
                    console.error('Gemini chat response structure error:', result);
                }
            } catch (error) {
                logToAI(`Error: Failed to connect to AI service: ${error.message}.`, 'error');
                console.error('Gemini chat fetch error:', error);
            }
        }

        /**
         * Sends selected code to the Gemini API for explanation.
         */
        async function explainCode() {
            console.log('Explain Code button clicked.');
            const selectedCode = editor.getSelection();
            if (!selectedCode) {
                logToAI("Please select Tea code in the editor to explain.", 'info');
                return;
            }

            logToAI("AI Assistant: Explaining selected code...", 'info');

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `Explain the following Tea programming language code:\n\`\`\`tea\n${selectedCode}\n\`\`\`` }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('Gemini explanation response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    logToAI(`Explanation:\n${text}`, 'ai');
                } else {
                    logToAI(`Error: Failed to explain code. Unexpected AI response.`, 'error');
                    console.error('Gemini explanation response structure error:', result);
                }
            } catch (error) {
                logToAI(`Error: Failed to connect to AI service for explanation: ${error.message}.`, 'error');
                console.error('Gemini explanation fetch error:', error);
            }
        }

        /**
         * Sends selected code to the Gemini API for refactoring.
         */
        async function refactorCode() {
            console.log('Refactor Code button clicked.');
            const selectedCode = editor.getSelection();

            if (!selectedCode) {
                logToAI("Please select Tea code in the editor to refactor.", 'info');
                return;
            }

            logToAI("AI Assistant: Refactoring selected code...", 'info');

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `Refactor the following Tea programming language code. Provide only the refactored code, no explanations or additional text:\n\`\`\`tea\n${selectedCode}\n\`\`\`` }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('Gemini refactoring response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    const codeMatch = text.match(/```tea\n([\s\S]*?)\n```/);
                    const refactoredText = codeMatch ? codeMatch[1].trim() : text.trim();

                    editor.replaceSelection(refactoredText);
                    
                    logToAI(`Code refactored. Please review changes in the editor.`, 'info');
                } else {
                    logToAI(`Error: Failed to refactor code. Unexpected AI response.`, 'error');
                    console.error('Gemini refactoring response structure error:', result);
                }
            }
            catch (error) {
                logToAI(`Error: Failed to connect to AI service for refactoring: ${error.message}.`, 'error');
                console.error('Gemini refactoring fetch error:', error);
            }
        }

        /**
         * Sends a natural language prompt to the Gemini API for code generation.
         */
        async function generateCode() {
            console.log('Generate Code button clicked.');
            const userPrompt = dom.aiInput.value.trim();
            if (!userPrompt) {
                logToAI("Please provide a description for code generation in the input field.", 'info');
                return;
            }

            logToAI(`AI Assistant: Generating code for: "${userPrompt}"...`, 'info');

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `Generate Tea programming language code for the following request. Provide only the Tea code, no explanations or additional text:\n"${userPrompt}"` }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('Gemini generation response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    const codeMatch = text.match(/```tea\n([\s\S]*?)\n```/);
                    const generatedText = codeMatch ? codeMatch[1].trim() : text.trim();

                    editor.replaceSelection(generatedText);
                    
                    logToAI(`Code generated. Please review and integrate into your project.`, 'info');
                    dom.aiInput.value = ''; // Clear the input field
                } else {
                    logToAI(`Error: Failed to generate code. Unexpected AI response.`, 'error');
                    console.error('Gemini generation response structure error:', result);
                }
            } catch (error) {
                logToAI(`Error: Failed to connect to AI service for code generation: ${error.message}.`, 'error');
                console.error('Gemini generation fetch error:', error);
            }
        }

        /**
         * Simulates AI training.
         */
        async function trainAI() {
            console.log('Train AI button clicked.');
            let trainingType;
            try {
                trainingType = await showModal("Enter Training Type", "Specify training type: explanation, refactoring, generation, or chat.", { type: 'text', placeholder: 'e.g., explanation' });
                if (!trainingType) throw new Error("Training cancelled.");
                trainingType = trainingType.toLowerCase();
                if (!['explanation', 'refactoring', 'generation', 'chat'].includes(trainingType)) {
                    throw new Error("Invalid training type. Please choose from: explanation, refactoring, generation, chat.");
                }
            } catch (error) {
                logToAI(`AI Training: ${error.message}`, 'error');
                return;
            }

            let inputData, outputData;
            try {
                inputData = await showModal(`Train ${trainingType.charAt(0).toUpperCase() + trainingType.slice(1)}`, `Enter the input data for ${trainingType} training:`, { type: 'text', placeholder: 'Input data' });
                if (!inputData) throw new Error("Training cancelled.");
                outputData = await showModal(`Train ${trainingType.charAt(0).toUpperCase() + trainingType.slice(1)}`, `Enter the desired output data for this input:`, { type: 'text', placeholder: 'Output data' });
                if (!outputData) throw new Error("Training cancelled.");
            } catch (error) {
                logToAI(`AI Training: ${error.message}`, 'error');
                return;
            }

            logToAI(`AI Assistant: Training data for '${trainingType}' received. Input: "${inputData}", Output: "${outputData}". Knowledge base updated.`, 'info');
            console.log('Simulated AI training data:', { type: trainingType, input: inputData, output: outputData });
        }


        /**
         * Toggles the terminal's collapsed state.
         */
        function toggleTerminalCollapse() {
            console.log('Terminal collapse button clicked.');
            if (state.terminalState === 'collapsed') {
                state.terminalState = 'default';
                dom.terminal.classList.remove('collapsed', 'fullscreen');
                dom.terminalContent.style.display = 'flex'; // Show content
                dom.terminalCollapseBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>'; // Down arrow
            } else {
                state.terminalState = 'collapsed';
                dom.terminal.classList.add('collapsed');
                dom.terminal.classList.remove('fullscreen');
                dom.terminalContent.style.display = 'none'; // Hide content
                dom.terminalCollapseBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>'; // Up arrow
            }
            dom.terminalOutput.scrollTop = dom.terminalOutput.scrollHeight; // Scroll to bottom
            logToTerminal(`Terminal state: ${state.terminalState}.`, 'info');
        }

        /**
         * Toggles the terminal's fullscreen state.
         */
        function toggleTerminalFullscreen() {
            console.log('Terminal fullscreen button clicked.');
            if (state.terminalState === 'fullscreen') {
                state.terminalState = 'default';
                dom.terminal.classList.remove('fullscreen');
                dom.terminal.classList.remove('collapsed'); // Ensure not collapsed
                dom.terminalContent.style.display = 'flex'; // Show content
                dom.terminalFullscreenBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m-4 7v4m0 0h-4m0 0l5-5m11 1v4m0 0h-4m0 0l-5-5"></path></svg>'; // Maximize icon
            } else {
                state.terminalState = 'fullscreen';
                dom.terminal.classList.add('fullscreen');
                dom.terminal.classList.remove('collapsed'); // Ensure not collapsed
                dom.terminalContent.style.display = 'flex'; // Always show content in fullscreen
                dom.terminalFullscreenBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m-4 7v4m0 0h-4m0 0l5-5m11 1v4m0 0h-4m0 0l-5-5"></path></svg>'; // Restore icon (same icon for simplicity)
            }
            dom.terminalOutput.scrollTop = dom.terminalOutput.scrollHeight; // Scroll to bottom
            logToTerminal(`Terminal state: ${state.terminalState}.`, 'info');
        }

        // --- Tea Language Interpreter (Simplified) ---
        class TeaEngine {
            constructor(terminalLogger, outputSandboxElement) { // Removed showCoffeeSpillAnimation parameter
                this.log = terminalLogger;
                this.sandbox = outputSandboxElement;
                this.variables = {}; // Simple variable store
                this.uiElements = {}; // Stores references to created UI elements
            }

            /**
             * Runs a given Tea code snippet.
             * @param {string} code - The Tea code to execute.
             */
            run(code) {
                this.log('--- TeaEngine: Starting execution ---', 'info');
                this.sandbox.innerHTML = ''; // Clear previous UI output
                this.uiElements = {}; // Clear UI element references
                this.variables = {}; // Reset variables for a fresh run

                const lines = code.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('//'));

                for (const line of lines) {
                    try {
                        this._executeCommand(line);
                    } catch (e) {
                        this.log(`Execution Error: ${e.message} in line: "${line}"`, 'error');
                        // Removed this.showCoffeeSpill();
                        break; // Stop execution on first error
                    }
                }
                this.log('--- TeaEngine: Execution finished ---', 'info');
            }

            /**
             * Executes a single Tea command line.
             * @param {string} commandLine - The command string.
             */
            _executeCommand(commandLine) {
                let match;

                // Debug.Log(string message);
                match = commandLine.match(/^Debug\.Log\((.+)\);?$/);
                if (match) {
                    let message = this._evaluateExpression(match[1]);
                    this.log(String(message), 'info');
                    return;
                }

                // UI.CreateElement(string type, string id);
                match = commandLine.match(/^UI\.CreateElement\("([^"]+)",\s*"([^"]+)"\);?$/);
                if (match) {
                    const type = match[1];
                    const id = match[2];
                    if (this.uiElements[id]) {
                        throw new Error(`UI element with ID '${id}' already exists.`);
                    }
                    const element = document.createElement(type);
                    element.id = id;
                    this.sandbox.appendChild(element);
                    this.uiElements[id] = element;
                    this.log(`Created UI element: <${type} id="${id}">`, 'info');
                    return;
                }

                // UI.SetText(string id, string text);
                match = commandLine.match(/^UI\.SetText\("([^"]+)",\s*(.+)\);?$/);
                if (match) {
                    const id = match[1];
                    const text = this._evaluateExpression(match[2]);
                    const element = this.uiElements[id];
                    if (!element) throw new Error(`UI element with ID '${id}' not found.`);
                    element.textContent = String(text);
                    this.log(`Set text for '${id}' to '${text}'.`, 'info');
                    return;
                }

                // UI.AttachEvent(string id, string eventType, string callbackCode);
                match = commandLine.match(/^UI\.AttachEvent\("([^"]+)",\s*"([^"]+)",\s*"(.*)"\);?$/);
                if (match) {
                    const id = match[1];
                    const event = match[2];
                    const callbackCode = match[3];
                    const element = this.uiElements[id];
                    if (!element) throw new Error(`UI element with ID '${id}' not found.`);
                    
                    // Pass the current TeaEngine's variables to the callback's engine for shared scope
                    const callbackEngine = new TeaEngine(this.log, this.sandbox);
                    callbackEngine.variables = this.variables; // Share variables
                    
                    element.addEventListener(event, () => {
                        this.log(`Event '${event}' triggered on '${id}'. Executing callback...`, 'info');
                        callbackEngine.run(callbackCode);
                    });
                    this.log(`Attached '${event}' listener to '${id}'.`, 'info');
                    return;
                }

                // UI.DisplayStaticText(string id, string content);
                match = commandLine.match(/^UI\.DisplayStaticText\("([^"]+)",\s*(.+)\);?$/);
                if (match) {
                    const id = match[1];
                    const content = this._evaluateExpression(match[2]);
                    let element = this.uiElements[id];
                    if (!element) {
                        element = document.createElement('div');
                        element.id = id;
                        this.sandbox.appendChild(element);
                        this.uiElements[id] = element;
                        this.log(`Created new div for text element: <div id="${id}">.`, 'info');
                    }
                    element.textContent = String(content);
                    this.log(`Displayed static text for '${id}' with '${content}'.`, 'info');
                    return;
                }

                // Data.StoreValue(string key, string value);
                match = commandLine.match(/^Data\.StoreValue\((.+),\s*(.+)\);?$/);
                if (match) {
                    const key = this._evaluateExpression(match[1]); // Evaluate key (can be a variable)
                    const value = this._evaluateExpression(match[2]); // Evaluate value (can be a variable or literal)
                    this.variables[String(key)] = value; // Store in in-memory variables
                    simulatedSaveFile(String(key), String(value)); // Also save to persistent local DB
                    this.log(`Stored value '${value}' to key '${key}'.`, 'info');
                    return;
                }

                // Data.RetrieveValue(string key);
                match = commandLine.match(/^Data\.RetrieveValue\((.+)\);?$/);
                if (match) {
                    const key = this._evaluateExpression(match[1]);
                    const loadedValue = simulatedLoadFile(String(key)); // Load from persistent local DB
                    if (loadedValue !== null) {
                        this.variables[String(key)] = loadedValue; // Also store in in-memory variables
                        this.log(`Retrieved value for '${key}': ${loadedValue}`, 'info');
                        return loadedValue; // Return the value
                    } else {
                        this.log(`Key '${key}' not found in data storage.`, 'info');
                        return null;
                    }
                }

                // --- Arithmetic Commands ---
                const parseArgs = (argsString) => {
                    return argsString.split(',').map(arg => this._evaluateExpression(arg.trim()));
                };

                // Math.Add(double num1, double num2);
                match = commandLine.match(/^Math\.Add\((.+)\);?$/);
                if (match) {
                    const [num1, num2] = parseArgs(match[1]);
                    if (typeof num1 === 'number' && typeof num2 === 'number') {
                        const result = num1 + num2;
                        this.log(`Math.Add Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid arguments for Math.Add. Expected two numbers.`);
                    }
                    return;
                }

                // Math.Subtract(double num1, double num2);
                match = commandLine.match(/^Math\.Subtract\((.+)\);?$/);
                if (match) {
                    const [num1, num2] = parseArgs(match[1]);
                    if (typeof num1 === 'number' && typeof num2 === 'number') {
                        const result = num1 - num2;
                        this.log(`Math.Subtract Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid arguments for Math.Subtract. Expected two numbers.`);
                    }
                    return;
                }

                // Math.Multiply(double num1, double num2);
                match = commandLine.match(/^Math\.Multiply\((.+)\);?$/);
                if (match) {
                    const [num1, num2] = parseArgs(match[1]);
                    if (typeof num1 === 'number' && typeof num2 === 'number') {
                        const result = num1 * num2;
                        this.log(`Math.Multiply Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid arguments for Math.Multiply. Expected two numbers.`);
                    }
                    return;
                }

                // Math.Divide(double num1, double num2);
                match = commandLine.match(/^Math\.Divide\((.+)\);?$/);
                if (match) {
                    const [num1, num2] = parseArgs(match[1]);
                    if (typeof num1 === 'number' && typeof num2 === 'number') {
                        if (num2 === 0) throw new Error("Division by zero is not permitted.");
                        const result = num1 / num2;
                        this.log(`Math.Divide Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid arguments for Math.Divide. Expected two numbers.`);
                    }
                    return;
                }

                // Math.Power(double base, double exponent);
                match = commandLine.match(/^Math\.Power\((.+)\);?$/);
                if (match) {
                    const [base, exponent] = parseArgs(match[1]);
                    if (typeof base === 'number' && typeof exponent === 'number') {
                        const result = Math.pow(base, exponent);
                        this.log(`Math.Power Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid arguments for Math.Power. Expected two numbers.`);
                    }
                    return;
                }

                // Math.SquareRoot(double number);
                match = commandLine.match(/^Math\.SquareRoot\((.+)\);?$/);
                if (match) {
                    const [number] = parseArgs(match[1]);
                    if (typeof number === 'number') {
                        if (number < 0) throw new Error("Cannot compute square root of a negative number.");
                        const result = Math.sqrt(number);
                        this.log(`Math.SquareRoot Result: ${result}`, 'info');
                    } else {
                        throw new Error(`Invalid argument for Math.SquareRoot. Expected a number.`);
                    }
                    return;
                }

                // Math.SolveLinear(double m, double b, double y_value);
                match = commandLine.match(/^Math\.SolveLinear\((.+)\);?$/);
                if (match) {
                    const [m, b, y_value] = parseArgs(match[1]);
                    if (typeof m === 'number' && typeof b === 'number' && typeof y_value === 'number') {
                        if (m === 0) {
                            if (y_value === b) {
                                this.log(`Linear Equation Solution: Infinite solutions.`, 'info');
                            } else {
                                this.log(`Linear Equation Solution: No solution.`, 'info');
                            }
                        } else {
                            const x = (y_value - b) / m;
                            this.log(`Linear Equation Solution for x: ${x}`, 'info');
                        }
                    } else {
                        throw new Error(`Invalid arguments for Math.SolveLinear. Expected three numbers (m, b, y_value).`);
                    }
                    return;
                }

                // Math.SolveQuadratic(double a, double b, double c);
                match = commandLine.match(/^Math\.SolveQuadratic\((.+)\);?$/);
                if (match) {
                    const [a, b, c] = parseArgs(match[1]);
                    if (typeof a === 'number' && typeof b === 'number' && typeof c === 'number') {
                        if (a === 0) throw new Error("Coefficient 'a' cannot be zero for a quadratic equation.");
                        const discriminant = b * b - 4 * a * c;
                        if (discriminant > 0) {
                            const x1 = (-b + Math.sqrt(discriminant)) / (2 * a);
                            const x2 = (-b - Math.sqrt(discriminant)) / (2 * a);
                            this.log(`Quadratic Equation Solutions: x1 = ${x1}, x2 = ${x2}.`, 'info');
                        } else if (discriminant === 0) {
                            const x = -b / (2 * a);
                            this.log(`Quadratic Equation Solution: x = ${x}.`, 'info');
                        } else {
                            const realPart = -b / (2 * a);
                            const imaginaryPart = Math.sqrt(Math.abs(discriminant)) / (2 * a);
                            this.log(`Quadratic Equation Solutions (Complex): x1 = ${realPart} + ${imaginaryPart}i, x2 = ${realPart} - ${imaginaryPart}i.`, 'info');
                        }
                    } else {
                        throw new Error(`Invalid arguments for Math.SolveQuadratic. Expected three numbers (a, b, c).`);
                    }
                    return;
                }

                // For any other command, log as unsupported
                throw new Error(`Unsupported command or syntax: "${commandLine}"`);
            }

            /**
             * Basic expression evaluator for string literals, numbers, and variable lookups.
             * @param {string} expr - The expression string.
             * @returns {*} The evaluated value.
             */
            _evaluateExpression(expr) {
                expr = expr.trim();

                // 1. Handle variable lookups
                // Check if it's a valid identifier (starts with letter/underscore, followed by alphanumeric/underscore)
                if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(expr)) {
                    if (this.variables.hasOwnProperty(expr)) {
                        return this.variables[expr];
                    } else {
                        // If it's a variable but not found, treat it as a string literal for now
                        // or throw an error if strict variable declaration is needed.
                        // For this version, let's throw an error to indicate undefined variable.
                        throw new Error(`Undefined variable: '${expr}'.`);
                    }
                }

                // 2. Handle string literals (double quotes)
                if (expr.startsWith('"') && expr.endsWith('"')) {
                    return expr.substring(1, expr.length - 1);
                }
                // 3. Handle string literals (single quotes)
                if (expr.startsWith("'") && expr.endsWith("'")) {
                    return expr.substring(1, expr.length - 1);
                }

                // 4. Handle numbers
                if (!isNaN(Number(expr))) {
                    return Number(expr);
                }
                // 5. Handle boolean literals
                if (expr === 'true') return true;
                if (expr === 'false') return false;

                throw new Error(`Unsupported expression type or syntax for evaluation: '${expr}'.`);
            }
        }

        // --- Run Code Function ---
        function runCode() {
            console.log('Run Code button clicked.');
            const codeToRun = editor.getValue();

            editor.getWrapperElement().classList.add('hidden');
            dom.outputSandbox.classList.remove('hidden');

            const teaEngine = new TeaEngine(logToTerminal, dom.outputSandbox); // Removed showCoffeeSpillAnimation
            teaEngine.run(codeToRun);
            
            logToTerminal('--- Code Execution Finished ---', 'info');

            if (!state.openTabs.includes('output-tab')) {
                state.openTabs.push('output-tab');
            }
            state.activeFile = 'output-tab';
            renderTabs();
        }


        /**
         * Populates the command dictionary based on a search filter.
         * @param {string} filter - The search string to filter commands.
         */
        function populateCommandDictionary(filter = '') {
            console.log('Populating command dictionary with filter:', filter);
            dom.commandList.innerHTML = '';
            const lowerFilter = filter.toLowerCase();
            const filteredCommands = teaCommands.filter(cmd => 
                cmd.name.toLowerCase().includes(lowerFilter) || 
                cmd.desc.toLowerCase().includes(lowerFilter)
            );
            
            if (filteredCommands.length === 0) {
                dom.commandList.innerHTML = `<p class="text-secondary p-2">No commands found.</p>`;
                return;
            }

            filteredCommands.forEach(cmd => {
                const cmdItem = document.createElement('div');
                cmdItem.className = 'p-2 rounded-md hover:bg-tertiary cursor-pointer transition-colors duration-150';
                cmdItem.innerHTML = `<strong class="command-name">${cmd.name}</strong><p class="text-xs text-secondary">${cmd.desc}</p>`;
                cmdItem.addEventListener('click', () => {
                    if (state.activeFile === 'commands-tab' && state.openTabs.length > 0) {
                        openFile(state.openTabs[0]);
                    } else if (state.activeFile === 'commands-tab' && state.openTabs.length === 0) {
                        createNewFile();
                    }

                    editor.focus();
                    const doc = editor.getDoc();
                    const cursor = doc.getCursor();
                    // Insert command name including parentheses and semicolon for C++-like syntax
                    const commandToInsert = cmd.name;
                    doc.replaceRange(commandToInsert, cursor);
                    // Position cursor inside parentheses if applicable
                    const parenIndex = commandToInsert.indexOf('(');
                    if (parenIndex !== -1) {
                        doc.setCursor({line: cursor.line, ch: cursor.ch + parenIndex + 1});
                    } else {
                        doc.setCursor({line: cursor.line, ch: cursor.ch + commandToInsert.length});
                    }
                    logToTerminal(`Command '${cmd.name}' inserted.`, 'info');
                });
                dom.commandList.appendChild(cmdItem);
            });
        }

        /**
         * Exports all files from the current active database key's section
         * as a .tea-project JSON file.
         */
        function exportProject() {
            console.log('Export All Files button clicked.');
            saveCurrentFile();
            
            const projectData = {
                activeFile: state.activeFile !== 'commands-tab' ? state.activeFile : null,
                files: state.files,
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const exportFileName = `${currentUserId}-project.tea-project`; 
            a.download = exportFileName; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logToTerminal(`All files for '${currentUserId}' exported as ${a.download}.`, 'success');
        }

        // --- EVENT LISTENERS ---
        dom.newFileBtn.addEventListener('click', () => {
            console.log('New .tpr button clicked.');
            createNewFile();
        });
        dom.openFileBtn.addEventListener('click', () => {
            console.log('Open .tpr button clicked. Triggering file upload input.');
            dom.fileUpload.click();
        });

        dom.fileUpload.addEventListener('change', (event) => {
            console.log('File selected for upload.');
            const file = event.target.files[0];
            if (!file) {
                console.warn('No file selected.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.tpr')) {
                    state.files[file.name] = content;
                    openFile(file.name);
                    await simulatedSaveFile(file.name, content);
                    logToTerminal(`Opened and added .tpr file: ${file.name} to active database key '${currentUserId}'.`, 'success');
                } else if (file.name.endsWith('.tea-project')) {
                    try {
                        const projectData = JSON.parse(content);
                        if (projectData.files && typeof projectData.files === 'object') {
                            const importKey = await showModal('Import Project', 'Enter a database key to import these files under:', { type: 'text', placeholder: 'Imported Project Key' });
                            if (!importKey) {
                                logToTerminal('Import cancelled.', 'info');
                                return;
                            }

                            const db = getSimulatedDatabase();
                            db[importKey] = db[importKey] || {};
                            for (const fileName in projectData.files) {
                                if (projectData.files.hasOwnProperty(fileName)) {
                                    db[importKey][fileName] = projectData.files[fileName];
                                }
                            }
                            setSimulatedDatabase(db);
                            logToTerminal(`Imported project files under new database key: '${importKey}'.`, 'success');
                            setActiveDatabaseKey(importKey);
                        } else {
                            logToTerminal('Error: Invalid .tea-project file format. Missing "files" property.', 'error');
                        }
                    } catch (error) {
                        logToTerminal(`Error parsing .tea-project file: ${error.message}.`, 'error');
                        console.error('File parsing error:', error);
                    }
                } else {
                    logToTerminal('Error: Please select a valid .tpr or .tea-project file.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        });

        dom.terminalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                console.log('Terminal input Enter key pressed.');
                handleTerminalCommand(dom.terminalInput.value);
                dom.terminalInput.value = '';
            }
        });
        
        dom.aiInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && dom.aiInput.value.trim() !== '') {
                console.log('AI input Enter key pressed for chat.');
                handleAIQuery(dom.aiInput.value); 
                dom.aiInput.value = '';
            }
        });

        dom.themeSwitcher.addEventListener('change', (e) => {
            console.log('Theme switcher changed to:', e.target.value);
            dom.body.className = e.target.value;
            if (editor) {
                const themeName = e.target.value.replace('theme-', '');
                editor.setOption('theme', 'dracula'); // Default to dracula for all dark themes
            }
            logToTerminal(`Theme switched to ${e.target.value}.`, 'info');
        });
        
        dom.commandSearch.addEventListener('keyup', (e) => {
            console.log('Command search input changed:', e.target.value);
            populateCommandDictionary(e.target.value);
        });

        dom.toggleLeft.addEventListener('click', () => {
            console.log('Toggle Left Sidebar button clicked.');
            dom.leftSidebar.classList.toggle('open');
            if (dom.leftSidebar.classList.contains('open') && dom.rightSidebar.classList.contains('open')) {
                dom.rightSidebar.classList.remove('open');
            }
            logToTerminal(`Left sidebar toggled.`, 'info');
        });
        dom.toggleRight.addEventListener('click', () => {
            console.log('Toggle Right Sidebar button clicked.');
            dom.rightSidebar.classList.toggle('open');
            if (dom.rightSidebar.classList.contains('open') && dom.leftSidebar.classList.contains('open')) {
                dom.leftSidebar.classList.remove('open');
            }
            logToTerminal(`Right sidebar toggled.`, 'info');
        });

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024) {
                const isClickInsideLeft = dom.leftSidebar.contains(e.target) || dom.toggleLeft.contains(e.target);
                const isClickInsideRight = dom.rightSidebar.contains(e.target) || dom.toggleRight.contains(e.target);

                if (dom.leftSidebar.classList.contains('open') && !isClickInsideLeft) {
                    dom.leftSidebar.classList.remove('open');
                    logToTerminal('Left sidebar closed.', 'info');
                }
                if (dom.rightSidebar.classList.contains('open') && !isClickInsideRight) {
                    dom.rightSidebar.classList.remove('open');
                    logToTerminal('Right sidebar closed.', 'info');
                }
            }
        });

        dom.exportBtn.addEventListener('click', exportProject);

        dom.explainCodeBtn.addEventListener('click', explainCode);
        dom.refactorCodeBtn.addEventListener('click', refactorCode);
        dom.generateCodeBtn.addEventListener('click', generateCode);
        dom.trainAiBtn.addEventListener('click', trainAI);

        dom.viewDatabasesBtn.addEventListener('click', viewAllDatabases);
        
        dom.resetIdeBtn.addEventListener('click', async () => {
            console.log('Reset IDE button clicked.');
            const confirmReset = await showModal('Reset IDE', 'Are you sure you want to reset the IDE? This will clear all local state (including all your saved database sections!) and reload the page. This cannot be undone.', { type: 'none' });
            if (confirmReset) {
                logToTerminal('Initiating IDE reset...', 'info');
                localStorage.clear();
                window.location.reload();
            } else {
                logToTerminal('IDE reset aborted.', 'info');
            }
        });

        dom.terminalHeaderToggle.addEventListener('click', (e) => {
            console.log('Terminal header clicked.');
            if (!e.target.closest('#terminal-fullscreen-btn') && !e.target.closest('#terminal-collapse-btn')) {
                toggleTerminalCollapse();
            }
        });
        dom.terminalCollapseBtn.addEventListener('click', toggleTerminalCollapse);
        dom.terminalFullscreenBtn.addEventListener('click', toggleTerminalFullscreen);

        dom.runCodeBtn.addEventListener('click', runCode);

        // --- INITIAL SETUP ---
        editor = CodeMirror(dom.editorContainer, {
            value: "// Welcome to Tea IDE!\n// Start coding your professional Tea applications here.\n\n" +
                   "// Example: Debug.Log(\"Hello from Tea!\");\n" +
                   "// Example: UI.CreateElement(\"button\", \"myButton\");\n" +
                   "// UI.SetText(\"myButton\", \"Click Me!\");\n" +
                   "// UI.AttachEvent(\"myButton\", \"click\", \"Debug.Log(\\\"Button clicked!\\\");\");\n" +
                   "// Example: UI.DisplayStaticText(\"myTextDiv\", \"This is some static text.\");\n" +
                   "// Example: Debug.Log(Math.Add(5.0, 3.0));\n" +
                   "// Example: Debug.Log(Math.SolveQuadratic(1.0, -3.0, 2.0));\n" +
                   "// Example: Data.StoreValue(\"myVar\", \"Hello Variable!\");\n" +
                   "// Debug.Log(Data.RetrieveValue(\"myVar\"));", // Added example for Data.StoreValue and RetrieveValue
            mode: "javascript",
            theme: "dracula",
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            autofocus: true,
            lineWrapping: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete"
            }
        });

        const initialUserFiles = getSimulatedDatabase()[currentUserId] || {};
        state.files = { ...initialUserFiles };
        const initialFileNames = Object.keys(state.files);

        if (initialFileNames.length > 0) {
            const previouslyActiveFile = localStorage.getItem(`active_file_${currentUserId}`);
            if (previouslyActiveFile && state.files.hasOwnProperty(previouslyActiveFile)) {
                openFile(previouslyActiveFile);
            } else {
                openFile(initialFileNames[0]);
            }
        } else {
            createNewFile();
        }
        renderTabs();
        renderFileExplorer();
    </script>
</body>
</html>
